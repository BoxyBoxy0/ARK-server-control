<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ARK Server Panel</title>
  <style>
    body { font-family: system-ui, Arial; max-width: 720px; margin: 24px auto; padding: 0 16px; }
    .card { border: 1px solid #ddd; border-radius: 12px; padding: 16px; margin: 12px 0; }
    button { padding: 10px 14px; border-radius: 10px; border: 1px solid #ccc; cursor: pointer; margin-right: 8px; }
    input { padding: 10px 12px; border-radius: 10px; border: 1px solid #ccc; width: 100%; box-sizing: border-box; }
    pre { background: #f6f6f6; padding: 12px; border-radius: 10px; overflow: auto; }
    .row { display: grid; grid-template-columns: 1fr; gap: 10px; }
    .status { font-weight: 700; }
  </style>
</head>
<body>
  <h1>ARK Server Control</h1>

  <div class="card">
    <div class="row">
      <label>
        Backend Base URL (ngrok)
        <input id="baseUrl" placeholder="https://xxxx.ngrok-free.dev" />
      </label>

      <label>
        Access Token (shared)
        <input id="token" placeholder="CONTROL_TOKEN" />
      </label>

      <button onclick="saveSettings()">Save</button>
    </div>
  </div>

  <div class="card">
    <div class="status">Status: <span id="statusText">Unknown</span></div>
    <div>Last update: <span id="statusTime">—</span></div>
    <p id="statusHint" style="color:#666; margin: 8px 0 0;"></p>
  </div>

  <div class="card">
    <button onclick="doAction('start')">Start</button>
    <button onclick="doAction('stop')">Stop</button>
    <button onclick="doAction('restart')">Restart</button>
    <button onclick="refreshStatus()">Refresh Status</button>
  </div>

  <div class="card">
    <strong>Debug output</strong>
    <pre id="output">(nothing yet)</pre>
  </div>

<script>
  function $(id){ return document.getElementById(id); }

  function saveSettings() {
    localStorage.setItem("ark_baseUrl", $("baseUrl").value.trim());
    localStorage.setItem("ark_token", $("token").value.trim());
    refreshStatus();
  }

  function loadSettings() {
    $("baseUrl").value = localStorage.getItem("ark_baseUrl") || "";
    $("token").value = localStorage.getItem("ark_token") || "";
  }

  function log(obj) {
    $("output").textContent = typeof obj === "string" ? obj : JSON.stringify(obj, null, 2);
  }

  function getCfg() {
    const baseUrl = $("baseUrl").value.trim().replace(/\/+$/, "");
    const token = $("token").value.trim();
    if (!baseUrl) throw new Error("Missing Backend Base URL");
    if (!token) throw new Error("Missing Access Token");
    return { baseUrl, token };
  }

  async function safeJson(resp) {
    const ct = resp.headers.get("content-type") || "";
    const text = await resp.text();
    if (ct.includes("application/json")) return JSON.parse(text);
    // This is the exact fix for your earlier: Unexpected token '<'
    // It happens when the response is HTML (like an ngrok/404 page).
    throw new Error(`Expected JSON, got: ${text.slice(0, 80)}...`);
  }

  function inferOnOff(data) {
    // Nitrado’s response structure can vary; we do a best-effort parse:
    const raw = JSON.stringify(data).toLowerCase();

    if (raw.includes("started") || raw.includes("running") || raw.includes("online")) return "Likely ON";
    if (raw.includes("stopped") || raw.includes("offline")) return "Likely OFF";
    return "Unknown (see debug)";
  }

  async function doAction(action) {
    try {
      const { baseUrl, token } = getCfg();
      const resp = await fetch(`${baseUrl}/api/${action}`, {
        method: "POST",
        headers: {
          "x-control-token": token,
          "Content-Type": "application/json"
        }
      });

      const data = await safeJson(resp);
      log(data);
      await refreshStatus();
    } catch (e) {
      log(`Action failed: ${e}`);
    }
  }

  async function refreshStatus() {
    try {
      const { baseUrl, token } = getCfg();

      const resp = await fetch(`${baseUrl}/api/status`, {
        method: "GET",
        headers: { "x-control-token": token }
      });

      const data = await safeJson(resp);

      $("statusText").textContent = inferOnOff(data);
      $("statusTime").textContent = new Date().toLocaleTimeString();
      $("statusHint").textContent = "If it says Unknown, check the Debug output for the exact JSON.";
      log(data);
    } catch (e) {
      $("statusText").textContent = "Failed";
      $("statusTime").textContent = new Date().toLocaleTimeString();
      $("statusHint").textContent = "";
      log(`Status failed: ${e}`);
    }
  }

  loadSettings();
  // Auto fetch status when page opens:
  if ($("baseUrl").value && $("token").value) refreshStatus();
  // Auto-refresh every 10 seconds:
  setInterval(() => {
    if ($("baseUrl").value && $("token").value) refreshStatus();
  }, 10000);
</script>
</body>
</html>
