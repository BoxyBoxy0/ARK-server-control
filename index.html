<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>ARK Server Control</title>
    <style>
      body { font-family: sans-serif; max-width: 720px; margin: 40px auto; }
      button { padding: 10px 14px; margin-right: 10px; }
      code { background: #f2f2f2; padding: 2px 6px; border-radius: 6px; }
      pre { background: #f7f7f7; padding: 12px; border-radius: 10px; overflow:auto; }
      .status-row { display: flex; align-items: center; gap: 12px; margin: 10px 0; }
      .status-indicator { display: inline-flex; align-items: center; gap: 8px; font-weight: bold; }
      .status-dot { width: 12px; height: 12px; border-radius: 50%; background: #aaa; box-shadow: 0 0 0 1px #999 inset; }
      .status-detail { color: #666; font-size: 0.9em; }
    </style>
  </head>
  <body>
    <h1>ARK Server Control</h1>

    <p>Backend: <code id="backend"></code></p>

    <div class="status-row">
      <span class="status-indicator" aria-live="polite">
        <span id="status-dot" class="status-dot" aria-hidden="true"></span>
        <span id="status-text">Checking…</span>
      </span>
      <span id="status-detail" class="status-detail"></span>
    </div>

    <div>
      <button onclick="start()">Start</button>
      <button onclick="stop()">Stop</button>
    </div>

    <h3>Output</h3>
    <pre id="out">Click a button…</pre>

    <script>
      const BACKEND_BASE_URL = "https://finniest-fransisca-ureido.ngrok-free.dev";
      const CONTROL_TOKEN = "ark-panel-9f3k2lq8";

      document.getElementById("backend").textContent = BACKEND_BASE_URL;

      function show(x) {
        document.getElementById("out").textContent =
          typeof x === "string" ? x : JSON.stringify(x, null, 2);
      }

      function setStatusVisual(label, color, detailText = "") {
        const dot = document.getElementById("status-dot");
        const text = document.getElementById("status-text");
        const detail = document.getElementById("status-detail");

        dot.style.background = color;
        text.textContent = label;
        detail.textContent = detailText ? `(${detailText})` : "";
      }

      // IMPORTANT for ngrok: avoids HTML interstitial
      function apiHeaders(extra = {}) {
        return {
          "Accept": "application/json",
          "ngrok-skip-browser-warning": "true",
          ...extra
        };
      }

      async function readJsonOrThrow(response) {
        const ct = (response.headers.get("content-type") || "").toLowerCase();

        // If it claims to be JSON, parse it normally.
        if (ct.includes("application/json")) {
          return await response.json();
        }

        // Otherwise read as text so we can show what actually came back (often HTML).
        const text = await response.text();
        const preview = text.slice(0, 300).replace(/\s+/g, " ").trim();
        throw new Error(
          `Expected JSON but got content-type "${ct || "unknown"}" (HTTP ${response.status}). ` +
          `Response starts: ${preview}`
        );
      }

      function parseOnlineStatus(payload) {
        // Your screenshot: payload.data.gameserver.status === "stopped"
        const raw =
          payload?.data?.gameserver?.status ??
          payload?.data?.status ??
          payload?.status ??
          payload?.message ??
          "";

        const s = String(raw).toLowerCase();

        // Treat transitional states as "Unknown" (yellow)
        const onlineWords = ["started", "running", "online", "up"];
        const offlineWords = ["stopped", "offline", "down"];

        const isOnline = onlineWords.some(w => s.includes(w));
        const isOffline = offlineWords.some(w => s.includes(w));

        if (isOnline) return { label: "Online", color: "#2ecc71", detail: raw };
        if (isOffline) return { label: "Offline", color: "#e74c3c", detail: raw };
        return { label: "Unknown", color: "#f1c40f", detail: raw };
      }

      async function refreshStatus() {
        try {
          setStatusVisual("Checking…", "#bbb");

          const r = await fetch(`${BACKEND_BASE_URL}/api/status`, {
            method: "GET",
            headers: apiHeaders(),
            cache: "no-store"
          });

          const data = await readJsonOrThrow(r);

          const statusInfo = parseOnlineStatus(data);
          setStatusVisual(statusInfo.label, statusInfo.color, statusInfo.detail);

          show({ httpStatus: r.status, data });
        } catch (e) {
          setStatusVisual("Status unavailable", "#e67e22");
          show("Status failed: " + (e?.message || e));
        }
      }

      async function start() {
        try {
          const r = await fetch(`${BACKEND_BASE_URL}/api/start`, {
            method: "POST",
            headers: apiHeaders({ "x-control-token": CONTROL_TOKEN })
          });

          const data = await readJsonOrThrow(r);
          show({ httpStatus: r.status, data });

          refreshStatus();
        } catch (e) {
          show("Start failed: " + (e?.message || e));
        }
      }

      async function stop() {
        try {
          const r = await fetch(`${BACKEND_BASE_URL}/api/stop`, {
            method: "POST",
            headers: apiHeaders({ "x-control-token": CONTROL_TOKEN })
          });

          const data = await readJsonOrThrow(r);
          show({ httpStatus: r.status, data });

          refreshStatus();
        } catch (e) {
          show("Stop failed: " + (e?.message || e));
        }
      }

      refreshStatus();
      // optional: refresh every 10s
      setInterval(refreshStatus, 10000);
    </script>
  </body>
</html>
