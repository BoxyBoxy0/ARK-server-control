<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>ARK Server Control</title>
    <style>
      :root{
        --bg:#0f1720; --card:#0b1220; --muted:#9aa6b2; --border:#22313f;
        --btn:#1f2937; --btnh:#2b3642; --good:#22c55e; --bad:#ef4444; --warn:#f59e0b;
      }
      body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:#e5e7eb}
      .wrap{max-width:760px;margin:40px auto;padding:0 16px}
      .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:20px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
      h1{margin:0 0 6px;font-size:24px}
      .sub{margin:0 0 18px;color:var(--muted);font-size:14px}
      .row{display:flex;gap:12px;flex-wrap:wrap}
      button{background:var(--btn);color:#e5e7eb;border:1px solid var(--border);border-radius:12px;padding:12px 14px;font-size:14px;cursor:pointer}
      button:hover{background:var(--btnh)}
      button:disabled{opacity:.6;cursor:not-allowed}
      .status{display:flex;align-items:center;gap:10px;margin:14px 0 10px}
      .dot{width:12px;height:12px;border-radius:999px;background:var(--warn)}
      .dot.online{background:var(--good)}
      .dot.offline{background:var(--bad)}
      .pill{font-size:12px;color:var(--muted);border:1px solid var(--border);padding:6px 10px;border-radius:999px}
      .log{margin-top:14px;font-family:ui-monospace,Consolas,monospace;font-size:12px;color:#cbd5e1;white-space:pre-wrap}
      .topbar{display:flex;justify-content:space-between;align-items:flex-start;gap:12px;flex-wrap:wrap}
      .pinbox{display:flex;gap:8px;align-items:center}
      input{background:#0a1220;color:#e5e7eb;border:1px solid var(--border);border-radius:10px;padding:10px 12px;outline:none}
    </style>
  </head>
  <body>
    <div class="wrap">
      <div class="card">
        <div class="topbar">
          <div>
            <h1>ARK Server Control</h1>
            <p class="sub">Start/stop your Nitrado server via your laptop backend (ngrok tunnel).</p>
          </div>

          <div class="pinbox">
            <input id="pin" type="password" inputmode="numeric" placeholder="PIN" />
            <button onclick="savePin()">Unlock</button>
          </div>
        </div>

        <div class="status">
          <span id="dot" class="dot"></span>
          <div>
            <div id="statusText">Unknown</div>
            <div class="pill" id="raw">raw: n/a</div>
          </div>
        </div>

        <div class="row">
          <button id="btnStatus" onclick="status()">Refresh Status</button>
          <button id="btnStart" onclick="start()">Start</button>
          <button id="btnStop" onclick="stop()">Stop</button>
          <button id="btnRestart" onclick="restart()">Restart</button>
        </div>

        <div class="log" id="log"></div>
      </div>
    </div>

    <script>
      // ✅ Put your ngrok base URL here (no trailing slash)
      const BACKEND_BASE = "https://finniest-fransisca-ureido.ngrok-free.dev";

      const logEl = document.getElementById("log");
      const dot = document.getElementById("dot");
      const statusText = document.getElementById("statusText");
      const rawEl = document.getElementById("raw");
      const pinInput = document.getElementById("pin");

      // Load saved PIN for convenience (still visible to whoever uses the device)
      const saved = sessionStorage.getItem("ark_pin");
      if (saved) pinInput.value = saved;

      function savePin() {
        sessionStorage.setItem("ark_pin", pinInput.value.trim());
        addLog("PIN saved for this session.");
        status(); // auto-check after unlock
      }

      function getPin() {
        return (sessionStorage.getItem("ark_pin") || "").trim();
      }

      function addLog(msg) {
        logEl.textContent = `[${new Date().toLocaleTimeString()}] ${msg}\n` + logEl.textContent;
      }

      async function api(path, method = "GET") {
        const pin = getPin();
        if (!pin) throw new Error("Enter PIN and press Unlock");

        const resp = await fetch(`${BACKEND_BASE}${path}`, {
          method,
          headers: { "x-pin": pin }
        });

        // If backend/route missing, ngrok returns HTML. Handle that cleanly:
        const contentType = resp.headers.get("content-type") || "";
        if (!contentType.includes("application/json")) {
          const text = await resp.text();
          throw new Error(`Non-JSON response (${resp.status}): ${text.slice(0, 120)}`);
        }

        const json = await resp.json();
        if (!resp.ok) {
          throw new Error(`${resp.status}: ${json.error || "Request failed"}`);
        }
        return json;
      }

      function setUi(online, rawStatus) {
        dot.classList.remove("online", "offline");
        if (online === true) dot.classList.add("online");
        else if (online === false) dot.classList.add("offline");
        statusText.textContent = online === true ? "Online" : online === false ? "Offline" : "Unknown";
        rawEl.textContent = "raw: " + (rawStatus ?? "n/a");
      }

      async function status() {
        try {
          addLog("Checking status…");
          const r = await api("/api/status", "GET");
          setUi(r.online, r.rawStatus);
          addLog("Status OK.");
        } catch (e) {
          addLog("Status failed: " + e.message);
        }
      }

      async function start() {
        try { addLog("Start…"); await api("/api/start", "POST"); addLog("Start requested."); setTimeout(status, 1500); }
        catch(e){ addLog("Start failed: " + e.message); }
      }

      async function stop() {
        try { addLog("Stop…"); await api("/api/stop", "POST"); addLog("Stop requested."); setTimeout(status, 1500); }
        catch(e){ addLog("Stop failed: " + e.message); }
      }

      async function restart() {
        try { addLog("Restart…"); await api("/api/restart", "POST"); addLog("Restart requested."); setTimeout(status, 1500); }
        catch(e){ addLog("Restart failed: " + e.message); }
      }

      // Auto-check on page load (will ask for PIN if not saved)
      setTimeout(() => {
        if (getPin()) status();
        else addLog("Enter PIN and press Unlock to enable controls.");
      }, 200);
    </script>
  </body>
</html>
