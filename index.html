<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>ARK Server Control</title>
    <style>
      body { font-family: system-ui, Arial; max-width: 760px; margin: 40px auto; padding: 20px; }
      button { padding: 10px 14px; margin-right: 10px; cursor: pointer; }
      .pill { display:inline-flex; align-items:center; gap:10px; padding:10px 14px; border:1px solid #ccc; border-radius:999px; font-weight:700; }
      .dot { width:12px; height:12px; border-radius:999px; background:#f59e0b; }
      .dot.good { background:#16a34a; }
      .dot.bad { background:#ef4444; }
      pre { background:#111; color:#eee; padding: 12px; border-radius: 8px; overflow:auto; }
      .gate { padding: 12px; border: 1px solid #ccc; border-radius: 10px; margin: 14px 0; }
      input { padding: 10px; width: 200px; }
    </style>
  </head>

  <body>
    <h1>ARK Server Control</h1>
    <p>Backend: <code id="backend"></code></p>

    <div class="gate">
      <label>Panel PIN:</label>
      <input id="pin" type="password" placeholder="Enter PIN" />
      <button onclick="unlock()">Unlock</button>
      <button onclick="lock()">Lock</button>
      <p style="margin:10px 0 0;">
        PIN just hides buttons. Real protection is the backend token.
      </p>
    </div>

    <div class="pill">
      <span id="dot" class="dot"></span>
      <span id="statusText">UNKNOWN</span>
    </div>
    <p>Last check: <span id="lastCheck">—</span></p>

    <div id="controls" style="display:none; margin: 14px 0;">
      <button onclick="status()">Status</button>
      <button onclick="start()">Start</button>
      <button onclick="stop()">Stop</button>
      <button onclick="restart()">Restart</button>
    </div>

    <h3>Output</h3>
    <pre id="out">Locked. Enter PIN to show controls…</pre>

    <script>
      // ---- CONFIG ----
      const BACKEND_BASE_URL = "https://finniest-fransisca-ureido.ngrok-free.dev"; // your ngrok url
      const CONTROL_TOKEN = "ark-panel-9f3k2lq8"; // must match backend .env
      const PANEL_PIN = "1234"; // friend-friendly gate
      const AUTO_REFRESH_SECONDS = 20;

      document.getElementById("backend").textContent = BACKEND_BASE_URL;

      function show(x) {
        document.getElementById("out").textContent =
          typeof x === "string" ? x : JSON.stringify(x, null, 2);
      }

      function setPill(state) {
        const dot = document.getElementById("dot");
        dot.classList.remove("good", "bad");
        if (state === "ONLINE") dot.classList.add("good");
        if (state === "OFFLINE") dot.classList.add("bad");
        document.getElementById("statusText").textContent = state;
        document.getElementById("lastCheck").textContent = new Date().toLocaleString();
      }

      async function fetchJson(url, options) {
        const r = await fetch(url, options);
        const text = await r.text();
        try {
          return { r, data: JSON.parse(text) };
        } catch {
          // This prevents the "<!DOCTYPE ..." crash if something returns HTML
          return { r, data: { raw: text } };
        }
      }

      function unlock() {
        const pin = document.getElementById("pin").value.trim();
        if (pin !== PANEL_PIN) return show("Wrong PIN.");
        sessionStorage.setItem("ark_panel_unlocked", "1");
        document.getElementById("controls").style.display = "";
        show("Unlocked. Fetching status…");
        status();
      }

      function lock() {
        sessionStorage.removeItem("ark_panel_unlocked");
        document.getElementById("controls").style.display = "none";
        setPill("UNKNOWN");
        show("Locked.");
      }

      // On load: auto-show if unlocked in this tab
      (function init() {
        if (sessionStorage.getItem("ark_panel_unlocked") === "1") {
          document.getElementById("controls").style.display = "";
          show("Unlocked (session). Fetching status…");
          status();
        }
      })();

      async function status() {
        try {
          const { r, data } = await fetchJson(`${BACKEND_BASE_URL}/api/status/summary`, {
            method: "GET",
            headers: { "x-control-token": CONTROL_TOKEN }
          });

          if (!r.ok) {
            setPill("UNKNOWN");
            return show({ httpStatus: r.status, data });
          }

          setPill(data.state || "UNKNOWN");
          show(data);
        } catch (e) {
          setPill("UNKNOWN");
          show("Status failed: " + e);
        }
      }

      async function start() {
        try {
          const { r, data } = await fetchJson(`${BACKEND_BASE_URL}/api/start`, {
            method: "POST",
            headers: { "x-control-token": CONTROL_TOKEN }
          });
          show({ httpStatus: r.status, data });
          setTimeout(status, 2500);
        } catch (e) { show("Start failed: " + e); }
      }

      async function stop() {
        try {
          const { r, data } = await fetchJson(`${BACKEND_BASE_URL}/api/stop`, {
            method: "POST",
            headers: { "x-control-token": CONTROL_TOKEN }
          });
          show({ httpStatus: r.status, data });
          setTimeout(status, 2500);
        } catch (e) { show("Stop failed: " + e); }
      }

      async function restart() {
        try {
          const { r, data } = await fetchJson(`${BACKEND_BASE_URL}/api/restart`, {
            method: "POST",
            headers: { "x-control-token": CONTROL_TOKEN }
          });
          show({ httpStatus: r.status, data });
          setTimeout(status, 2500);
        } catch (e) { show("Restart failed: " + e); }
      }

      if (AUTO_REFRESH_SECONDS > 0) {
        setInterval(() => {
          if (sessionStorage.getItem("ark_panel_unlocked") === "1") status();
        }, AUTO_REFRESH_SECONDS * 1000);
      }
    </script>
  </body>
</html>
