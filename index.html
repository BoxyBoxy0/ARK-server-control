<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>ARK Server Control</title>
    <style>
      :root{
        --bg:#0f1720;
        --card:#0b1220;
        --muted:#9aa6b2;
        --border:#22313f;
        --button:#1f2937;
        --button-hover:#323f4a;
      }
      html,body{height:100%}
      body {
        font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial;
        max-width: 820px;
        margin: 40px auto;
        background: linear-gradient(180deg,#06121a 0%, #071923 100%);
        color:#e6eef6;
        padding: 28px;
      }
      .container {
        border: 2px solid var(--border);
        border-radius: 12px;
        padding: 22px;
        box-shadow: 0 8px 30px rgba(2,6,23,0.6);
      }
      h1{margin-top:0}
      p{color:var(--muted)}
      code { background: #07111a; padding: 4px 8px; border-radius:8px; border:1px solid var(--border); }
      pre { background:#07111a; padding: 14px; border-radius: 10px; border: 2px solid var(--border); overflow:auto; }
      button {
        padding: 10px 16px;
        margin-right: 10px;
        border-radius: 8px;
        border: 2px solid var(--border);
        background: var(--button);
        color: #eaf3ff;
        font-weight:700;
        cursor:pointer;
      }
      button:hover{ background:var(--button-hover); }
      .row { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
      .badge {
        display:inline-block;
        padding: 6px 10px;
        border-radius: 999px;
        border: 1px solid var(--border);
        font-weight: 800;
      }
    </style>
  </head>

  <body>
    <div class="container">
      <h1>ARK Server Control</h1>

      <p>Backend: <code id="backend"></code></p>

      <div class="row" style="margin: 10px 0 18px;">
        <div>Server:</div>
        <div class="badge" id="serverState">UNKNOWN</div>
        <div style="color:#9aa6b2; font-size: 13px;" id="lastUpdate"></div>
      </div>

      <div class="row" style="margin-bottom: 16px;">
        <button onclick="status()">Status</button>
        <button onclick="start()">Start</button>
        <button onclick="stop()">Stop</button>
        <button onclick="restart()">Restart</button>
      </div>

      <h3>Output</h3>
      <pre id="out">Loading…</pre>
    </div>

    <script>
      const BACKEND_BASE_URL = "https://finniest-fransisca-ureido.ngrok-free.dev";
      const CONTROL_TOKEN = "ark-panel-9f3k2lq8"; // temp/simple auth

      document.getElementById("backend").textContent = BACKEND_BASE_URL;

      function show(x) {
        document.getElementById("out").textContent =
          typeof x === "string" ? x : JSON.stringify(x, null, 2);
      }

      function setState(text) {
        document.getElementById("serverState").textContent = text;
        document.getElementById("lastUpdate").textContent =
          "Last checked: " + new Date().toLocaleTimeString();
      }

      // Very simple inference: we search the returned JSON for status-ish words
      function inferOnOff(payload) {
        const s = JSON.stringify(payload).toLowerCase();
        if (s.includes("running") || s.includes("started") || s.includes("online")) return "ON";
        if (s.includes("stopped") || s.includes("offline") || s.includes("suspended")) return "OFF";
        return "UNKNOWN";
      }

      async function callJson(path, options = {}) {
        const r = await fetch(`${BACKEND_BASE_URL}${path}`, {
          ...options,
          headers: {
            "x-control-token": CONTROL_TOKEN,
            ...(options.headers || {}),
          },
        });

        const text = await r.text();
        let data;
        try {
          data = JSON.parse(text);
        } catch {
          // If this happens, you’re not receiving JSON from your backend (often backend crashed)
          throw new Error(`Non-JSON response (HTTP ${r.status}): ${text.slice(0, 120)}...`);
        }
        return { status: r.status, data };
      }

      async function status() {
        try {
          const { status, data } = await callJson("/api/status", { method: "GET" });
          show({ httpStatus: status, data });
          setState(inferOnOff(data));
        } catch (e) {
          show("Status failed: " + e);
          setState("UNKNOWN");
        }
      }

      async function start() {
        try {
          const { status, data } = await callJson("/api/start", { method: "POST" });
          show({ httpStatus: status, data });
          await status();
        } catch (e) {
          show("Start failed: " + e);
        }
      }

      async function stop() {
        try {
          const { status, data } = await callJson("/api/stop", { method: "POST" });
          show({ httpStatus: status, data });
          await status();
        } catch (e) {
          show("Stop failed: " + e);
        }
      }

      async function restart() {
        try {
          const { status, data } = await callJson("/api/restart", { method: "POST" });
          show({ httpStatus: status, data });
          await status();
        } catch (e) {
          show("Restart failed: " + e);
        }
      }

      // Auto-check on page load + every 15 seconds
      status();
      setInterval(status, 15000);
    </script>
  </body>
</html>
