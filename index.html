<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ARK Server Control</title>
  <style>
    body { font-family: system-ui, Arial; max-width: 680px; margin: 40px auto; padding: 0 16px; }
    .card { border: 1px solid #ddd; border-radius: 14px; padding: 18px; }
    .row { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 14px; }
    button { padding: 10px 14px; border-radius: 12px; border: 1px solid #ccc; cursor: pointer; background: #fff; }
    button.primary { border-color: #111; }
    .status { display: flex; align-items: center; gap: 10px; margin-top: 12px; }
    .dot { width: 12px; height: 12px; border-radius: 50%; background: #999; }
    .dot.on { background: #22c55e; }
    .dot.off { background: #ef4444; }
    .muted { color: #666; font-size: 14px; }
    input { padding: 10px 12px; border-radius: 12px; border: 1px solid #ccc; width: 240px; }
    pre { background: #f6f6f6; padding: 12px; border-radius: 12px; overflow: auto; }
  </style>
</head>
<body>
  <h1>ARK Server Control</h1>

  <div class="card">
    <div class="muted">PIN-protected controls (simple). Your PIN is stored locally in your browser.</div>

    <div class="row" style="margin-top:12px;">
      <input id="pin" type="password" placeholder="Enter PIN" />
      <button class="primary" onclick="savePin()">Save PIN</button>
      <button onclick="clearPin()">Clear</button>
    </div>

    <div class="status">
      <div id="dot" class="dot"></div>
      <div>
        <div><strong id="statusText">Unknown</strong></div>
        <div class="muted" id="statusSub">Not checked yet</div>
      </div>
    </div>

    <div class="row">
      <button onclick="callApi('start')">Start</button>
      <button onclick="callApi('stop')">Stop</button>
      <button onclick="callApi('restart')">Restart</button>
      <button class="primary" onclick="refreshStatus()">Refresh status</button>
    </div>

    <details style="margin-top:12px;">
      <summary class="muted">Debug output</summary>
      <pre id="out">(none)</pre>
    </details>
  </div>

<script>
  // ✅ Set this to your ngrok base URL (NO trailing slash)
  const BACKEND_BASE = "https://YOUR-NGROK-SUBDOMAIN.ngrok-free.dev";

  const pinEl = document.getElementById("pin");
  const outEl = document.getElementById("out");
  const dotEl = document.getElementById("dot");
  const statusTextEl = document.getElementById("statusText");
  const statusSubEl = document.getElementById("statusSub");

  // Load saved PIN
  pinEl.value = localStorage.getItem("ark_pin") || "";

  function savePin() {
    localStorage.setItem("ark_pin", pinEl.value.trim());
    log("PIN saved locally.");
    refreshStatus();
  }

  function clearPin() {
    localStorage.removeItem("ark_pin");
    pinEl.value = "";
    log("PIN cleared.");
    setStatusUI("unknown", "Not checked yet");
  }

  function getPin() {
    return (localStorage.getItem("ark_pin") || pinEl.value || "").trim();
  }

  function log(msg) {
    outEl.textContent = msg;
  }

  function setStatusUI(state, sub) {
    // state could be "started"/"stopped"/unknown depending on API
    dotEl.className = "dot";
    if (String(state).toLowerCase().includes("start") || String(state).toLowerCase().includes("run")) {
      dotEl.classList.add("on");
      statusTextEl.textContent = "Online";
    } else if (String(state).toLowerCase().includes("stop") || String(state).toLowerCase().includes("down")) {
      dotEl.classList.add("off");
      statusTextEl.textContent = "Offline";
    } else {
      statusTextEl.textContent = "Unknown";
    }
    statusSubEl.textContent = sub;
  }

  async function callApi(action) {
    const pin = getPin();
    if (!pin) return log("Enter your PIN first.");

    const url = `${BACKEND_BASE}/api/${action}`;
    try {
      const resp = await fetch(url, {
        method: "POST",
        headers: {
          "X-Control-Token": pin
        }
      });

      const text = await resp.text();
      log(`${action.toUpperCase()} → ${resp.status}\n${text}`);

      // after start/stop/restart, refresh status
      setTimeout(refreshStatus, 1500);
    } catch (e) {
      log(`${action.toUpperCase()} failed: ${e}`);
    }
  }

  async function refreshStatus() {
    const pin = getPin();
    if (!pin) return setStatusUI("unknown", "Enter PIN to check status");

    const url = `${BACKEND_BASE}/api/status`;
    try {
      const resp = await fetch(url, {
        method: "GET",
        headers: {
          "X-Control-Token": pin
        }
      });

      const data = await resp.json();
      log(`STATUS → ${resp.status}\n${JSON.stringify(data, null, 2)}`);

      if (resp.ok) {
        setStatusUI(data.status, `Raw status: ${data.status}`);
      } else {
        setStatusUI("unknown", `Status check failed (${resp.status})`);
      }
    } catch (e) {
      setStatusUI("unknown", "Status failed (fetch/json error)");
      log(`Status failed: ${e}`);
    }
  }

  // ✅ Auto-check when page opens
  refreshStatus();
</script>
</body>
</html>
